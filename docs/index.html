<!-- ===========================
     RouterHaus v2 — index.html
     (Home) — polished & unified with site system
     =========================== -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="RouterHaus – AI-powered router recommendations for every space, from studio flats to multi-floor estates and offices." />
  <meta name="color-scheme" content="light dark" />
  <title>RouterHaus</title>
  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="#6f7dff">

  <!-- Fonts & Global -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="main.css" />
  <link rel="stylesheet" href="assets/css/home.css" />

  <!-- Preload blog index for the carousel -->
  <link rel="preload" href="assets/blog/blog.json" as="fetch" crossorigin="anonymous" />

  <!-- Theme sync (same pattern used on other pages) -->
  <script>
    (() => {
      const root = document.documentElement;
      const media = matchMedia('(prefers-color-scheme: dark)');
      const apply = () => root.setAttribute('data-theme', media.matches ? 'dark' : 'light');
      apply(); media.addEventListener('change', apply);
    })();
  </script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- Component-scoped styles: Journal carousel -->
  <style>
    /* ===== Journal (Home Blog Carousel) ===== */
    .journal{
      border-top:1px solid var(--border);
      background: linear-gradient(180deg, color-mix(in oklab, var(--surface-tertiary, rgba(0,0,0,.04)) 30%, transparent), transparent), var(--bg);
    }
    .journal .section-head{ margin-bottom: clamp(12px, 1.6vw, 18px); }
    .journal-headbar{
      display:flex; align-items:center; justify-content:space-between; gap:.75rem; flex-wrap:wrap;
      margin: .35rem 0 .6rem;
    }
    .journal-actions{ display:flex; align-items:center; gap:.5rem; }
    .journal-rail{
      position:relative;
    }
    .journal-track{
      display:grid;
      grid-auto-flow: column;
      grid-auto-columns: minmax(clamp(260px, 26vw, 360px), 1fr);
      gap: clamp(12px, 1.6vw, 18px);
      overflow-x: auto;
      padding: .25rem .25rem .5rem;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .journal-track::-webkit-scrollbar{ height:10px; }
    .journal-track::-webkit-scrollbar-thumb{ background: color-mix(in oklab, var(--text-2) 16%, transparent); border-radius: 999px; }
    .edge-fade{
      pointer-events:none;
      position: absolute; inset: 0;
      mask: linear-gradient(90deg, rgba(0,0,0,.0) 0, rgba(0,0,0,1) 24px, rgba(0,0,0,1) calc(100% - 24px), rgba(0,0,0,.0) 100%);
      -webkit-mask: linear-gradient(90deg, rgba(0,0,0,.0) 0, rgba(0,0,0,1) 24px, rgba(0,0,0,1) calc(100% - 24px), rgba(0,0,0,.0) 100%);
      background: linear-gradient(180deg, transparent, transparent);
    }

    /* Card */
    .j-card{
      scroll-snap-align: start;
      display:grid; grid-template-rows: auto auto auto 1fr auto;
      gap:.55rem; padding: clamp(14px, 1.6vw, 18px);
      border:1px solid var(--border);
      border-radius: var(--radius-lg, 18px);
      background: color-mix(in oklab, var(--card) 92%, transparent);
      box-shadow: var(--shadow-sm);
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .j-card:hover{ transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: color-mix(in oklab, var(--accent) 28%, var(--border)); }
    .j-cover{
      position:relative; border-radius:14px; overflow:hidden; border:1px solid var(--border);
      aspect-ratio: 16/9; background: color-mix(in oklab, var(--primary) 10%, transparent);
    }
    .j-cover img{ width:100%; height:100%; object-fit:cover; display:block; }
    .j-badges{ position:absolute; top:.5rem; left:.5rem; display:flex; gap:.35rem; }
    .j-badge{ color:#fff; font-size:.72rem; font-weight:800; padding:.28rem .5rem; border-radius:999px; background: var(--success); box-shadow: var(--shadow-sm); }
    .j-title{ margin:.1rem 0 0; font-size: clamp(1rem, .95rem + .25vw, 1.125rem); line-height:1.25; }
    .j-meta{ display:flex; align-items:center; gap:.45rem; color: var(--text-2); font-size:.9rem; }
    .j-dot{ opacity:.6; color: var(--primary); }
    .j-tags{ display:flex; flex-wrap:wrap; gap:.35rem; margin:.1rem 0 .1rem; }
    .j-tag{ font-size:.75rem; font-weight:700; padding:.25rem .5rem; border-radius:999px; border:1px solid var(--border); background: color-mix(in oklab, var(--card) 88%, transparent); color: var(--text-1); }
    .j-excerpt{ color: var(--text-2); margin: .15rem 0 .2rem; }
    .j-cta{ display:flex; gap:.5rem; align-items:center; }
    .j-cta .btn{ padding:.6rem .85rem; }

    /* Arrows */
    .j-arrow{
      width:42px; height:42px; border-radius:12px; border:1px solid var(--border);
      background: var(--surface, color-mix(in oklab, var(--card) 92%, transparent));
      display:inline-flex; align-items:center; justify-content:center;
      box-shadow: var(--shadow-sm); cursor:pointer;
      transition: transform var(--t), box-shadow var(--t), border-color var(--t);
    }
    .j-arrow:hover{ transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: color-mix(in oklab, var(--primary) 40%, var(--border)); }
    .j-arrow[disabled]{ opacity:.45; cursor:not-allowed; transform:none; }

    /* Preview button visibility: desktop only */
    .j-preview{ display:none; }
    @media (min-width: 900px){ .j-preview{ display:inline-flex; } }

    /* Skeletons */
    .j-skel{ border-radius: var(--radius-lg); border:1px solid var(--border); background: color-mix(in oklab, var(--card) 92%, transparent); padding:14px; }
    .shimmer{ position:relative; overflow:hidden; }
    .shimmer::after{
      content:""; position:absolute; inset:0;
      background: linear-gradient(90deg, transparent, color-mix(in oklab, var(--bg-elev, #fff) 55%, transparent), transparent);
      transform: translateX(-100%); animation: j-shimmer 1.6s infinite;
    }
    .sk-cover{ height: 160px; border-radius:14px; background: color-mix(in oklab, var(--card) 80%, transparent); border:1px solid var(--border); }
    .sk-line{ height: 14px; border-radius:8px; margin:.5rem 0; background: color-mix(in oklab, var(--card) 80%, transparent); }
    @keyframes j-shimmer{ 100% { transform: translateX(100%); } }

    /* Dialog (preview) */
    dialog.hp-preview{
      width:min(95vw, 900px); max-height:95vh; border:none; border-radius: 22px;
      background: var(--surface, color-mix(in oklab, var(--card) 90%, transparent)); color: var(--text-1);
      box-shadow: var(--shadow-md); border:1px solid var(--border); overflow:hidden;
    }
    .hp-head{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; padding:16px 18px; border-bottom:1px solid var(--border); background: color-mix(in oklab, var(--card) 88%, transparent); }
    .hp-close{ width:40px; height:40px; border-radius:12px; border:1px solid var(--border); background: var(--surface); display:grid; place-items:center; cursor:pointer; }
    .hp-body{ display:grid; gap:12px; padding:16px 18px; overflow:auto; max-height: 70vh; }
    .hp-cover img{ width:100%; height:auto; border-radius:14px; border:1px solid var(--border); }
    .hp-meta{ color: var(--text-2); font-size:.95rem; }
    .hp-actions{ display:flex; justify-content:flex-end; gap:.5rem; padding:14px 18px; border-top:1px solid var(--border); background: color-mix(in oklab, var(--card) 88%, transparent); }
    dialog.hp-preview::backdrop{ background: rgba(0,0,0,.6); backdrop-filter: blur(6px); }
  </style>
</head>
<body>
  <!-- Header partial -->
  <div id="header-placeholder" data-partial="header.html"></div>

  <main class="home">
    <!-- ===== HERO ===== -->
    <section class="hero index-hero">
      <div class="container hero-grid">
        <div class="hero-copy reveal">
          <span class="eyebrow">AI-tuned network plans</span>
          <h1>Lightning-Fast <span class="nowrap">Wi-Fi</span>, <span class="grad">Zero Guesswork</span></h1>
          <p class="lede">Answer a few questions and get a dialed-in setup — sized to your space, devices, and plan speed.</p>
          <div class="hero-actions">
            <a href="kits.html?quiz=1" class="btn primary">Start Recommendation</a>
            <a href="consult.html" class="btn ghost">Talk to an Engineer</a>
          </div>
          <ul class="stat-pills" aria-label="Highlights">
            <li><i class="fa-solid fa-list-check" aria-hidden="true"></i> 3-step kit finder</li>
            <li><i class="fa-solid fa-gauge-high" aria-hidden="true"></i> Multi-gig ready</li>
            <li><i class="fa-solid fa-sitemap" aria-hidden="true"></i> Mesh for whole-home</li>
          </ul>
        </div>

        <aside class="hero-card glass reveal">
          <h3>What best describes you?</h3>
          <div class="persona-chips">
            <button class="chip" data-qpick="apt" type="button"><i class="fa-solid fa-city" aria-hidden="true"></i> Apartment / Condo</button>
            <button class="chip" data-qpick="large" type="button"><i class="fa-solid fa-house-chimney" aria-hidden="true"></i> Large Home</button>
            <button class="chip" data-qpick="wfh" type="button"><i class="fa-solid fa-briefcase" aria-hidden="true"></i> Work from Home</button>
            <button class="chip" data-qpick="gaming" type="button"><i class="fa-solid fa-gamepad" aria-hidden="true"></i> Gaming</button>
          </div>
          <p class="mini subtle"><i class="fa-regular fa-lightbulb" aria-hidden="true"></i> We’ll pre-apply the right filters — tweak anytime.</p>
        </aside>
      </div>
    </section>

    <!-- ===== TRUST ===== -->
    <section class="trust">
      <div class="container">
        <header class="section-head reveal">
          <h2>Trusted by pros & power users</h2>
          <p class="subtle">We build with proven vendors and sane defaults.</p>
        </header>
        <div class="trust-logos reveal" aria-label="Vendors we work with">
          <span class="pill">Ubiquiti</span>
          <span class="pill">Aruba</span>
          <span class="pill">TP-Link</span>
          <span class="pill">ASUS</span>
          <span class="pill">Synology</span>
          <span class="pill">MikroTik</span>
        </div>
      </div>
    </section>

    <!-- ===== HOW IT WORKS ===== -->
    <section class="steps">
      <div class="container">
        <header class="section-head reveal">
          <h2>How it works</h2>
          <p class="subtle">From quiz to install — clarity at every step.</p>
        </header>

        <div class="cards cards-3">
          <article class="card step reveal">
            <div class="step-icon"><i class="fa-solid fa-wand-magic-sparkles" aria-hidden="true"></i></div>
            <h3>1) Quick quiz</h3>
            <p>Tell us about your space, devices, and plan speed. We turn that into real-world requirements.</p>
          </article>

          <article class="card step reveal">
            <div class="step-icon"><i class="fa-solid fa-sliders" aria-hidden="true"></i></div>
            <h3>2) Compare picks</h3>
            <p>Filter by Wi-Fi gen, mesh, WAN tier, and price. Add up to four to compare.</p>
          </article>

          <article class="card step reveal">
            <div class="step-icon"><i class="fa-solid fa-diagram-project" aria-hidden="true"></i></div>
            <h3>3) Deploy</h3>
            <p>Use our guides or book an engineer. We can stage, tune, and hand off remotely or on-site.</p>
          </article>
        </div>
      </div>
    </section>

    <!-- ===== JOURNAL (blog carousel) ===== -->
    <section class="journal" aria-labelledby="journal-title">
      <div class="container">
        <header class="section-head">
          <h2 id="journal-title">From the Journal</h2>
          <p class="subtle">Guides, reviews, and Wi-Fi tactics.</p>
          <div class="journal-headbar">
            <div class="journal-actions">
              <button class="j-arrow" id="jPrev" type="button" aria-label="Scroll left"><i class="fa-solid fa-chevron-left"></i></button>
              <button class="j-arrow" id="jNext" type="button" aria-label="Scroll right"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
            <a class="btn ghost" href="blog.html" aria-label="See all articles">All articles</a>
          </div>
        </header>

        <div class="journal-rail">
          <div class="edge-fade" aria-hidden="true"></div>
          <div id="journalTrack" class="journal-track" role="list" aria-label="Recent articles">
            <!-- Skeletons (replaced by JS) -->
            <article class="j-skel shimmer" role="listitem" aria-hidden="true">
              <div class="sk-cover"></div>
              <div class="sk-line" style="width:70%"></div>
              <div class="sk-line" style="width:45%"></div>
              <div class="sk-line" style="width:90%"></div>
            </article>
            <article class="j-skel shimmer" role="listitem" aria-hidden="true">
              <div class="sk-cover"></div>
              <div class="sk-line" style="width:65%"></div>
              <div class="sk-line" style="width:40%"></div>
              <div class="sk-line" style="width:80%"></div>
            </article>
            <article class="j-skel shimmer" role="listitem" aria-hidden="true">
              <div class="sk-cover"></div>
              <div class="sk-line" style="width:60%"></div>
              <div class="sk-line" style="width:40%"></div>
              <div class="sk-line" style="width:85%"></div>
            </article>
          </div>
        </div>
      </div>

      <!-- Template for cards -->
      <template id="hpPostTpl">
        <article class="j-card reveal" role="listitem">
          <a class="j-cover" href="#" target="_self" rel="noopener">
            <img alt="" loading="lazy" />
            <div class="j-badges"><span class="j-badge" data-featured hidden>Featured</span></div>
          </a>
          <h3 class="j-title"><a class="title-link" href="#" target="_self" rel="noopener"></a></h3>
          <div class="j-meta">
            <span class="author"></span><span class="j-dot">•</span><time class="date"></time><span class="j-dot">•</span><span class="read"></span>
          </div>
          <div class="j-tags"></div>
          <p class="j-excerpt"></p>
          <div class="j-cta">
            <a class="btn" href="#" target="_self" rel="noopener">Read</a>
            <button class="btn ghost j-preview" type="button">Quick preview</button>
          </div>
        </article>
      </template>

      <!-- Preview dialog -->
      <dialog id="hpPreview" class="hp-preview" aria-labelledby="hpPreviewTitle">
        <div class="hp-head">
          <h3 id="hpPreviewTitle" style="margin:0; font-weight:800;"></h3>
          <button id="hpClose" class="hp-close" type="button" aria-label="Close preview"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="hp-body">
          <div class="hp-meta" id="hpMeta"></div>
          <div class="hp-cover" id="hpCover"></div>
          <article id="hpBody" class="hp-article"></article>
        </div>
        <div class="hp-actions">
          <a id="hpRead" class="btn primary" href="#" target="_self" rel="noopener">Go to full article</a>
        </div>
      </dialog>
    </section>

    <!-- ===== FEATURED PICKS ===== -->
    <section class="product-grid">
      <div class="container">
        <header class="section-head reveal">
          <h2>Great consumer picks</h2>
          <p class="subtle">Fast, reliable, and simple to manage.</p>
        </header>

        <div class="product-row">
          <article class="product glass reveal">
            <div class="product-media" role="img" aria-label="TP-Link Deco BE25">
              <img src="Deco-BE25.png" alt="TP-Link Deco BE25" />
            </div>
            <h4>TP-Link Deco BE25</h4>
            <p class="tag">Apartments & small homes</p>
            <p class="meta">≈ 6,600 sq ft • $249.99</p>
            <a class="btn ghost" href="kits.html?coverage=Apartment/Small&recos=1">View options</a>
          </article>

          <article class="product glass reveal">
            <div class="product-media" role="img" aria-label="Google Nest Wi-Fi Pro 3-pack">
              <img src="google-nest-wi-fi.png" alt="Google Nest Wi-Fi Pro 3-pack" />
            </div>
            <h4>Google Nest Wi-Fi Pro (3-pack)</h4>
            <p class="tag">Seamless setup</p>
            <p class="meta">≈ 6,600 sq ft • $399.99</p>
            <a class="btn ghost" href="kits.html?mesh=Mesh-ready&recos=1">View options</a>
          </article>

          <article class="product glass reveal">
            <div class="product-media" role="img" aria-label="ASUS ROG GT-BE98 Pro">
              <img src="ASUS-BE98.png" alt="ASUS ROG GT-BE98 Pro" />
            </div>
            <h4>ASUS ROG GT-BE98 Pro</h4>
            <p class="tag">Gaming & performance</p>
            <p class="meta">≈ 4,800 sq ft • $629.99</p>
            <a class="btn ghost" href="kits.html?use=Gaming&wan=2.5G&recos=1">View options</a>
          </article>
        </div>
      </div>
    </section>

    <!-- ===== ENTERPRISE STRIP ===== -->
    <section class="enterprise-band">
      <div class="container band-grid">
        <div class="band-copy reveal">
          <h2>For businesses & large properties</h2>
          <p class="subtle">Multi-floor roaming, VLAN separation, multi-gig backbones, and controller-based tuning.</p>
        </div>
        <div class="band-ctas reveal">
          <a class="btn primary" href="consult.html">Enterprise / Large Home Consult</a>
          <a class="btn ghost" href="kits.html?mesh=Mesh-ready&coverage=Large/Multi-floor&recos=1">See mesh systems</a>
        </div>
      </div>
    </section>

    <!-- ===== FAQ ===== -->
    <section id="faq" class="faq">
      <div class="container">
        <h2 class="faq-title reveal">FAQ</h2>

        <div class="accordion">
          <div class="accordion-item reveal">
            <h4>Do you support on-site installs?</h4><span aria-hidden="true">+</span>
            <p>Yes. We can coordinate on-site installation, validation, and handover. Remote staging and controller setup are also available.</p>
          </div>

          <div class="accordion-item reveal">
            <h4>Will the quiz work for office spaces?</h4><span aria-hidden="true">+</span>
            <p>It’s a great start for sizing and features. For multi-tenant or multi-AP scenarios, book a consult and we’ll design the topology.</p>
          </div>

          <div class="accordion-item reveal">
            <h4>Do you only recommend one brand?</h4><span aria-hidden="true">+</span>
            <p>No — we’re vendor-agnostic. We’ll suggest the right gear for your goals, scale, and environment.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== CTA ===== -->
    <section class="footer-cta" id="start">
      <div class="container">
        <div class="cta-inner reveal">
          <h2>Design Your Network</h2>
          <p>From a studio flat to a full campus — we’ve got you covered.</p>
          <div class="hero-actions">
            <a href="kits.html?quiz=1" class="btn primary">Start Matching →</a>
            <a href="consult.html" class="btn ghost">Enterprise Consult</a>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer partial -->
  <div id="footer-placeholder" data-partial="footer.html"></div>

  <!-- Scripts -->
  <script src="scripts.js" defer></script>
  <script type="module" src="assets/js/home.js"></script>

  <!-- Home-only: Journal carousel logic (standalone, no dependency on blog.js) -->
  <script type="module">
    (() => {
      const $ = (s, r=document) => r.querySelector(s);
      const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
      const track = $('#journalTrack');
      const tpl = $('#hpPostTpl');
      const dlg = $('#hpPreview');
      const dTitle = $('#hpPreviewTitle'), dMeta = $('#hpMeta'), dCover = $('#hpCover'), dBody = $('#hpBody'), dRead = $('#hpRead'), dClose = $('#hpClose');
      const cfg = { json: 'assets/blog/blog.json', base: 'assets/blog', postSelector: 'article, main article, .post, #post' };

      const fmtDate = (d) => { try { return new Intl.DateTimeFormat(undefined, {year:'numeric', month:'short', day:'2-digit'}).format(new Date(d)); } catch { return d; } };
      const postUrl = (slug) => `${cfg.base.replace(/\/$/,'')}/${slug}.html`;
      const normalize = (p, i) => ({
        id: p.id || `hp_${i}_${(p.slug||p.title||'post').replace(/\W+/g,'').slice(0,18)}`,
        title: String(p.title||'Untitled').trim(),
        slug: String(p.slug || p.id || `post_${i}`),
        author: p.author || 'RouterHaus',
        date: p.date || new Date().toISOString().slice(0,10),
        tags: Array.isArray(p.tags) ? p.tags.filter(Boolean) : [],
        excerpt: p.excerpt || '',
        cover: typeof p.cover==='string' ? p.cover : '',
        minutes: Number.isFinite(+p.minutes) ? +p.minutes : undefined,
        featured: !!p.featured,
        views: Number.isFinite(+p.views) ? +p.views : 0,
        url: p.url || postUrl(p.slug || p.id || `post_${i}`),
        _contentHtml: '',
        _contentText: '',
      });

      async function fetchIndex(){
        try{
          const r = await fetch(cfg.json, { cache: 'no-store' });
          if(!r.ok) throw new Error('bad status');
          const arr = await r.json();
          return (Array.isArray(arr)?arr:[]).map(normalize);
        }catch{
          return [];
        }
      }

      async function fetchPostBody(p){
        if (p._contentHtml) return p;
        try{
          const r = await fetch(p.url, { cache: 'no-store' });
          if(!r.ok) throw new Error('bad status');
          const html = await r.text();
          const doc = new DOMParser().parseFromString(html, 'text/html');
          const node = doc.querySelector(cfg.postSelector) || doc.body;
          node.querySelectorAll('script,style,iframe,object,embed,link').forEach(n=>n.remove());
          node.querySelectorAll('a[href]').forEach(a=>{ a.target='_blank'; a.rel='noopener' });
          p._contentHtml = node.innerHTML;
          p._contentText = node.textContent || '';
          if (!p.minutes) p.minutes = Math.max(3, Math.round(p._contentText.split(/\s+/).filter(Boolean).length / 200));
        }catch{
          p._contentHtml ||= `<p>${escapeHtml(p.excerpt)}</p>`;
          p._contentText ||= p.excerpt || '';
          if (!p.minutes) p.minutes = Math.max(3, Math.round((p._contentText||'').split(/\s+/).filter(Boolean).length / 200));
        }
        return p;
      }

      const escapeHtml = (s) => String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
      const isDesktop = () => matchMedia('(min-width:900px)').matches;

      function render(posts){
        track.innerHTML = '';
        const frag = document.createDocumentFragment();
        posts.forEach((p, idx) => {
          const node = tpl.content.cloneNode(true);
          const aCover = node.querySelector('.j-cover'); const img = node.querySelector('img');
          const badge = node.querySelector('[data-featured]');
          const tLink = node.querySelector('.title-link');
          const author = node.querySelector('.author'); const date = node.querySelector('.date'); const read = node.querySelector('.read');
          const tags = node.querySelector('.j-tags'); const excerpt = node.querySelector('.j-excerpt');
          const readBtn = node.querySelector('.j-cta .btn'); const prevBtn = node.querySelector('.j-preview');

          aCover.href = p.url; aCover.target = '_self'; aCover.setAttribute('aria-label', p.title);
          img.src = p.cover || ''; img.alt = '';

          if (p.featured) badge.hidden = false;

          tLink.href = p.url; tLink.textContent = p.title; tLink.target = '_self';
          author.textContent = p.author; date.textContent = fmtDate(p.date); read.textContent = p.minutes ? `${p.minutes} min read` : '';

          tags.innerHTML = (p.tags||[]).slice(0,3).map(t => `<span class="j-tag">${escapeHtml(t)}</span>`).join('');
          excerpt.textContent = p.excerpt;

          readBtn.href = p.url; readBtn.target = '_self';

          // Prefetch on hover (desktop) and wire preview
          const prefetch = () => fetchPostBody(p).catch(()=>{});
          [aCover, tLink, prevBtn].forEach(el => el && el.addEventListener('mouseenter', () => { if (isDesktop()) prefetch(); }, { once:true }));
          prevBtn?.addEventListener('click', async () => openPreview(await fetchPostBody(p)));

          // First two images not lazy for better LCP perception in viewport
          if (idx > 1) img.loading = 'lazy';

          frag.appendChild(node);
        });
        track.appendChild(frag);
        revealify();
        updateArrows();
      }

      function revealify(){
        const els = $$('.reveal', track);
        if (!('IntersectionObserver' in window) || !els.length) return;
        const io = new IntersectionObserver((entries)=>{
          entries.forEach(en=>{ if(en.isIntersecting){ en.target.classList.add('in-view'); io.unobserve(en.target); } });
        }, { threshold: 0.1, rootMargin: '0px 0px -10% 0px' });
        els.forEach(el=>io.observe(el));
      }

      // Dialog behavior
      let lastFocus = null;
      async function openPreview(p){
        if (!dlg) return;
        lastFocus = document.activeElement;
        dTitle.textContent = p.title;
        dMeta.textContent = `${p.author} • ${fmtDate(p.date)}${p.minutes ? ' • ' + p.minutes + ' min read' : ''}`;
        dCover.innerHTML = p.cover ? `<img src="${escapeHtml(p.cover)}" alt="">` : '';
        dBody.innerHTML = p._contentHtml || `<p>${escapeHtml(p.excerpt||'')}</p>`;
        dRead.href = p.url;
        try { dlg.showModal(); } catch { dlg.setAttribute('open',''); }
      }
      function closePreview(){
        try { dlg.close(); } catch { dlg.removeAttribute('open'); }
        if (lastFocus && typeof lastFocus.focus === 'function') lastFocus.focus();
      }
      dClose?.addEventListener('click', closePreview);
      dlg?.addEventListener('click', (e) => {
        const r = dlg.getBoundingClientRect();
        const inside = e.clientX >= r.left && e.clientX <= r.right && e.clientY >= r.top && e.clientY <= r.bottom;
        if (!inside) closePreview();
      });
      dlg?.addEventListener('cancel', (e)=>{ e.preventDefault(); closePreview(); });

      // Arrows and scroll
      const prev = $('#jPrev'), next = $('#jNext');
      const scrollByAmount = () => Math.max(track.clientWidth * 0.9, 320);
      prev?.addEventListener('click', () => track.scrollBy({ left: -scrollByAmount(), behavior:'smooth' }));
      next?.addEventListener('click', () => track.scrollBy({ left:  scrollByAmount(), behavior:'smooth' }));
      track?.addEventListener('scroll', throttle(updateArrows, 80), { passive:true });
      function updateArrows(){
        const max = track.scrollWidth - track.clientWidth - 1;
        prev.disabled = (track.scrollLeft <= 1);
        next.disabled = (track.scrollLeft >= max);
      }
      function throttle(fn, wait=80){ let t=0, id; return (...a)=>{ const n=Date.now(); if(n-t>=wait){ t=n; fn(...a);} else { clearTimeout(id); id=setTimeout(()=>{ t=Date.now(); fn(...a); }, wait-(n-t)); } }; }

      // Init
      (async () => {
        const posts = (await fetchIndex()).sort((a,b)=> new Date(b.date)-new Date(a.date));
        const picked = pickPosts(posts, 6);
        render(picked);
      })();

      function pickPosts(arr, n=6){
        if (!arr.length) return [];
        const feat = arr.filter(p=>p.featured);
        const rest = arr.filter(p=>!p.featured);
        const ordered = [...feat.slice(0,1), ...rest].slice(0, n);
        return ordered;
      }
    })();
  </script>
</body>
</html>
